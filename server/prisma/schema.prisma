generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
//  USER MODEL
//

model User {
  id                String    @id @default(cuid())
  username          String    @unique() @default(cuid())
  email             String    @unique()
  password          String?
  name              String?
  bio               String?
  createdAt         DateTime  @default(now())
  refreshTokens     String[]  @default([])
  friendCount       Int       @default(0)
  passwordChangedAt DateTime?

  // Google Specific Fields
  googleId String? @unique
  avatar   String?

  // Updated Relation: Unified Movie Tracking
  userMovies UserMovie[]

  // Friend System
  sentFriendRequests     FriendRequest[]     @relation("SentRequests")
  receivedFriendRequests FriendRequest[]     @relation("ReceivedRequests")
  friendshipsA           Friendship[]        @relation("FriendA")
  friendshipsB           Friendship[]        @relation("FriendB")
  PasswordResetToken     PasswordResetToken? @relation("UserPasswordResetToken")

  // Notifications
  sentNotifications     Notification[] @relation("SentNotifications")
  receivedNotifications Notification[] @relation("ReceivedNotifications")

  @@map("users")
}

//
//  MOVIE MODELS
//

model Movies {
  id Int @id

  // Updated Relation
  userMovies UserMovie[]

  @@map("movies")
}

model UserMovie {
  id      String @id @default(cuid())
  userId  String @map("user_id")
  movieId Int    @map("movie_id")

  // The Features: Status + Favorites
  status     MovieStatus?
  isFavorite Boolean      @default(false)

  // User input
  rating Int?
  review String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movies @relation(fields: [movieId], references: [id], onDelete: Cascade)

  // Optimization: Prevents duplicates and speeds up specific user lookups
  @@unique([userId, movieId])
  @@index([userId, status])
  @@index([userId, isFavorite])
  @@map("user_movies")
}

enum MovieStatus {
  WATCHED
  PLANNED
  WATCHING
  DROPPED
  ON_HOLD
}

//
//  FRIEND & SYSTEM MODELS (Unchanged for logic consistency)
//

model FriendRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  createdAt  DateTime @default(now())

  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId])
}

model Friendship {
  id          String   @id @default(cuid())
  friend_a_id String
  friend_b_id String
  createdAt   DateTime @default(now())

  friendA User @relation("FriendA", fields: [friend_a_id], references: [id], onDelete: Cascade)
  friendB User @relation("FriendB", fields: [friend_b_id], references: [id], onDelete: Cascade)

  @@unique([friend_a_id, friend_b_id])
  @@index([friend_a_id])
  @@index([friend_b_id])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @unique()
  token     String   @unique()
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation("UserPasswordResetToken", fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailChangeTable {
  id        String   @id @default(cuid())
  userId    String   @unique()
  newEmail  String
  token     String   @unique()
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@map("email_change_table")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  senderId  String?
  type      NotificationType
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user   User  @relation("ReceivedNotifications", fields: [userId], references: [id], onDelete: Cascade)
  sender User? @relation("SentNotifications", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_REQUEST_ACCEPTED
  FRIEND_REQUEST_REJECTED
}
